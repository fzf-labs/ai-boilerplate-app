<!--
  WeChat Official Account Auto-Reply Form Component

  This component provides a modal form for creating and editing auto-reply rules.
  It supports different reply types (keyword, welcome, default) with conditional
  field visibility and proper validation.

  @author Auto-generated by Augment Agent
  @version 1.0.0
-->
<script lang="ts" setup>
import { computed, ref } from 'vue';

import { useVbenModal } from '@vben/common-ui';

import { message } from 'ant-design-vue';

import { useVbenForm } from '#/adapter/form';
import {
  createAutoReply,
  getAutoReplyInfo,
  getAutoReplyList,
  MpAutoReplyApi,
  updateAutoReply,
} from '#/api/gzh/autoReply';
import { $t } from '#/locales';

import { useFormSchema } from '../data';

const props = defineProps<{
  appId?: string; // 从搜索表单传递的公众号ID
}>();

const emit = defineEmits(['success']);

const formData = ref<MpAutoReplyApi.AutoReply>();
const isEditMode = ref(false);

const getTitle = computed(() => {
  return isEditMode.value
    ? $t('ui.actionTitle.edit', ['自动回复'])
    : $t('ui.actionTitle.create', ['自动回复']);
});

const [Form, formApi] = useVbenForm({
  commonConfig: {
    componentProps: {
      class: 'w-full',
    },
    formItemClass: 'col-span-2',
    labelWidth: 120,
  },
  layout: 'horizontal',
  schema: useFormSchema(),
  showDefaultActions: false,
});

/**
 * 检查是否已存在相同类型的自动回复
 * @param type 回复类型
 * @param appId 公众号ID
 * @param currentId 当前编辑的记录ID（编辑时排除自己）
 */
async function checkExistingAutoReply(
  type: number,
  appId: string,
  currentId?: string,
): Promise<boolean> {
  // 只对被关注回复和收到消息回复进行限制
  if (
    type !== MpAutoReplyApi.AutoReplyType.SUBSCRIBE &&
    type !== MpAutoReplyApi.AutoReplyType.MESSAGE
  ) {
    return false; // 关键词回复不限制
  }

  try {
    const response = await getAutoReplyList({
      page: 1,
      pageSize: 1000, // 获取所有记录
      appId,
      type,
    });

    // 过滤掉当前编辑的记录
    const existingReplies = response.list.filter(
      (item) => item.id !== currentId,
    );

    return existingReplies.length > 0;
  } catch (error) {
    console.error('检查现有自动回复失败:', error);
    return false;
  }
}

const [Modal, modalApi] = useVbenModal({
  async onConfirm() {
    const { valid } = await formApi.validate();
    if (!valid) {
      return;
    }
    modalApi.lock();

    try {
      // 提交表单
      const data = (await formApi.getValues()) as MpAutoReplyApi.AutoReply;
      // 检查是否已存在相同类型的自动回复
      const hasExisting = await checkExistingAutoReply(
        data.type,
        data.appId,
        formData.value?.id,
      );

      if (hasExisting) {
        const typeText =
          data.type === MpAutoReplyApi.AutoReplyType.SUBSCRIBE
            ? '被关注回复'
            : '收到消息回复';
        message.error(
          `该公众号已存在${typeText}，每个公众号只能设置一个${typeText}`,
        );
        return;
      }

      await (formData.value?.id
        ? updateAutoReply(data)
        : createAutoReply(data));
      // 关闭并提示
      await modalApi.close();
      emit('success');
      message.success($t('ui.actionMessage.operationSuccess'));
    } finally {
      modalApi.unlock();
    }
  },
  async onOpenChange(isOpen: boolean) {
    if (!isOpen) {
      formData.value = undefined;
      isEditMode.value = false;
      return;
    }
    // 加载数据
    const data = modalApi.getData<
      MpAutoReplyApi.AutoReply & { appId?: string }
    >();
    if (!data || !data.id) {
      // 新增模式
      isEditMode.value = false;
      // 新增时设置默认值，优先使用传递的 appId
      const defaultAppId = data?.appId || props.appId;
      if (defaultAppId) {
        await formApi.setValues({ appId: defaultAppId });
      }
      return;
    }
    // 编辑模式
    isEditMode.value = true;
    modalApi.lock();
    try {
      const res = await getAutoReplyInfo(data.id);
      formData.value = res.info;
      // 设置到 values
      await formApi.setValues(formData.value);
    } finally {
      modalApi.unlock();
    }
  },
});
</script>

<template>
  <Modal class="w-2/5" :title="getTitle">
    <Form class="mx-4" />
  </Modal>
</template>
